# 数据库编程规范

1．绪论
统一的施工标准是保证质量的重要因数，软件开发离不开清晰、严格的编码规范。本文档详细描述了SQL在软件开发过程中的编程规范，可供开发人员参考。
2．命名规则
2.1  表名
表名长度不能超过30个字符，表名中含有单词全部采用单数形式，单词要大写。多个单词间用下划线（_）进行连接。若库中有多个系统，表名采用系统名称+单词或多个单词，系统名是开发系统的缩写，如gsmdba。表中含有的单词建议用完整的单词。如果导致表名长度超过30个字符，则从最后一个单词开始，依次向前采用该单词的缩写。（如果没有约定的缩写，则采用该单词前4个字母来表示）。 
2.2  字段名
数据库字段名全部采用小写英文单词，单词之间用”_”隔开。字段长度不能超过30个字符。如果该字段是代码，则在单词后加_id。如果该字段表示的是时间，则使用_time为后缀。尽量做到从名称上对看出它的含义。不要使用关键字作为字段名。
2.2  视图名
视图名用V_开头，视图名长度不能超过30个字符。视图名用大写的英文单词来表示。 若某视图由几个表产生，就用下划线（_）连接几个表的名，如果表过多可以将表名适当简化，但一定要列出所有表名。
2.3  触发器名
 触发器名用T_开头，触发器名长度不能超过30个字符。触发器名用小写的英文单词来表示。
2.4  存储过程名
存储过程名用P_开头，存储过程名长度不能超过30个字符。存储过程名用小写的英文单词来表示。
2.5  变量名
变量名采用小写，若属于词组形式，用下划线分隔每个单词，如err_no。变量名不能超出ORACLE的限制（30个字符），要用英文命名，从变量上能看到变量的作用。
2.6  主键
主键名用pk_开头，后面跟该主键所在的表名。主键名长度不能超过30个字符。如果过长，可对表名进行缩写。缩写规则同表名的缩写规则。主键名用小写的英文单词来表示。
2.7  索引
索引名用小写的英文字母和数字表示。索引名的长度不能超过30个字符。主键对应的索引和主键同名。主键索引用PK_开头，唯一性索引用UINX_开头，后面跟表名。一般性索引用IDX_开头，后面跟表名。如果索引长度过长，可对表名进行缩写。缩写规则同表名的缩写规则。
2.8  包
包名用小写的英文字母和数字表示。包名的长度不能超过20个字符。一般包用pkg_开头。如果包长度过长，可对包名进行缩写。缩写规则同表名的缩写规则。

3.  数据库使用规范
3.1  对象划分规范
对于公用性比较强或工具类的存储过程或函数，建议统一规划在公参模型里，放在公共的Schema里，供调用。对于此类过程或函数，不建议放在包对象中。
对于同一个Schema下的所有函数、过程以及自定义类型等数据库对象等，建议封装包对象里。譬如数据清算中预处理、下发，前台Rap、财务清算等不同模块，可以拥有一个或者多个包对象，其所涉及的数据库对象需封装在适当的包对象里。
3.2  临时表规范
非必要情况下，不允许在数据库过程、函数或者其他程序里进行动态建表操作。如需临时表的话，则须在数据模型规划范围内，进行普通表或者oracle临时表的创建。
3.3  DDL语句使用规范
非必要情况下，不允许在数据库过程、函数或者其他程序里进行执行DDL语句。如需执行DDL语句的话，则须在数据模型规划范围内，进行DDL语句运行。
3.4  提交/回滚规范
非必要情况下，不允许在数据库过程、函数进行执行提交或回滚语句，否则容易引起外部调用会话的提交或回滚，影响事务的正常进行。对于一些自身业务功能独立、事务完整的业务存储过程或函数（例如系统最外围的、供程序独立调用的过程），可以在保证事务正常的情况下，加入提交或回滚语句。
3.5  Schema的使用
所有的SQL文件以及数据库过程、函数的编写过程中，必须带上Schema名称，保证数据库对象调用的正确性。
3.6  OCCI规范
待补充
4．注释规范
注释总的原则是尽可能全面、描述清晰、通俗易懂。
4.1需要注释的地方
(1)   应对不易理解的分支条件表达式加注释；   
  (2)   对重要的计算应说明其功能；   
  (3)   过长的函数实现，应将其语句按实现的功能分段加以概括性说明；   
  (4)   每条SQL语句均应有注释说明（表名、字段名）。   
  (5)   常量及变量注释时，应注释被保存值的含义(必须)，合法取值的范围(可选)   
(6)   可采用单行/多行注释。（-- 或 /* */ 方式）  

4.2函数注释
编写函数文本，如触发器、存储过程以及其他数据对象时，必须为每个函数增加适当注释。该注释以多行注释为主，主要结构如下：
/************************************************************************
*name        :               --函数名
*function    :                --函数功能
*input       :                --输入参数
*output      :                --输出参数
*author      :                --作者
*CreateDate  :               --创建时间
*UpdateDate  :               --函数更改信息（包括作者、时间、更改内容等）
*************************************************************************/

示例：
/***************************************************************
*name        :          --iigsmdba.fun_replace_data
*function    :           --三期分业务和测算系统数据稽核与替换
*input       :           --v_month（稽核月份）
*output      :           --null
*author      :           --zhanggan
*CreateDate  :           --2009-6-28
*UpdateDate  :           --null 
****************************************************************/
5．书写规范
1、语句中出现的所有表名、字段名全部小写，系统保留字、内置函数名、Sql保留字大写。   
2、连接符or、in、and、以及＝、<=、>=等前后加上一个空格。 
3、对较为复杂的sql语句加上注释，说明算法、功能。
4、SQL语句的缩进风格   
(1) 一行有多列，超过80个字符时，基于列对齐原则，采用下行缩进   
(2) where子句书写时，每个条件占一行，语句另起一行时，以保留字或者连接符开始，连接符右对齐。   
5、多表连接时，使用表的别名来引用列。  
6、删除不使用的变量，尽量在编写完成后立刻检查，否则会花费大量时间而且乏味。
7、系统保留字应大写，包括系统公共变量等。其他字符（如用户自定义变量、用户自定义数据对象名）小写。需要特殊强调的部分可以大写。一条完整注释语句的首字符应大写。对某变量、某条件字句的注释可以全部使用小写。
8、避免变量循环使用，一个变量只用于一个目的。
9、功能相似的过程和函数，尽量写到同一个包中，加强管理。
10、查找数据库表或视图时，只能取出确实需要的那些字段，不要使用*来代替所有列名。要清楚明白地使用列名，而不能使用列的序号。 

6．性能优化
1、避免嵌套连接。例如：A = B and B = C and C = D   
2、系统可能选择基于规则的优化器，所以将结果集返回数据量小的表作为驱动表（from后边最后一个表）。   
3、大量的排序操作影响系统性能，所以尽量减少order by和group by排序操作。   
如必须使用排序操作，请遵循如下规则：   
(1) 排序尽量建立在有索引的列上。   
(2) 如结果集不需唯一，使用union all代替union。   
4、合理的使用索引。 
(1) 尽量避免对索引列进行计算。如对索引列计算较多，请系统管理员建立函数索引。 
(2) 尽量注意比较值与索引列数据类型的一致性。 
(3) 对于复合索引，SQL语句必须使用主索引列。   
(4) 索引中，尽量避免使用NULL。 
(5) 对于索引的比较，尽量避免使用<>（!=）。 
(6) 查询列和排序列与索引列次序保持一致。   
5、尽量避免相同语句由于书写格式的不同，而导致多次语法分析，尽量使用Bind变量。   
6、查询的WHERE过滤原则，应使过滤记录数最多的条件放在最前面。   
7、任何对列的操作都将导致表扫描，它包括数据库函数、计算表达式等等，查询时要尽可能将操作移至等号右边。   
8、in、or子句常会使用工作表，使索引失效；如果不产生大量重复值，可以考虑把子句拆开；拆开的子句中应该包含索引。
7．异常处理
PL/SQL程序块的异常部分包含了程序处理错误的代码，它分为内部异常和用户自定义异常。当异常被抛出时，一个异常陷阱就自动发生，程序控制离开执行部分转入异常部分,一旦程序进入异常部分就不能再回到同一块的执行部分。

异常部分的一般结构： 
EXCEPTION 
WHEN exception_name THEN 
Code for handing exception_name 
[WHEN another_exception THEN 
Code for handing another_exception] 
[WHEN others THEN 
　　code for handing any other exception.] 

用户必须在独立的WHEN子串中为每个异常设计异常处理代码，WHEN OTHERS子串必须放置在最后面作为缺省处理器处理没有显式处理的异常。当异常发生时，控制转到异常部分，ORACLE查找当前异常相应的WHEN..THEN语句，捕捉异常，THEN之后的代码被执行，如果错误陷阱代码只是退出相应的嵌套块，那么程序将继续执行内部块END后面的语句。如果没有找到相应的异常陷阱，那么将执行WHEN OTHERS。在异常部分WHEN 子串没有数量限制。 
8．其他
1、尽量少用嵌套查询。如必须，请用not exist代替not in子句。   
2、用多表连接代替EXISTS子句。
3、少用DISTINCT，用EXISTS代替
4、使用UNION ALL、MINUS、INTERSECT提高性能   
5、使用ROWID提高检索速度。对SELECT得到的单行记录，需进行DELETE、UPDATE操作时，使用ROWID将会使效率大大提高。   
6、使用cursor时，显示光标优于隐式光标。


